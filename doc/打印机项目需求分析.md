# 打印机项目需求分析

## 1.0	整体分析

​	相比后两个题目更加注重后台部分的设计。对我来说，如果说后两个题目是前端后台工程复杂度是四六开或者五五开，那么第一个题目工程复杂度就是三七开甚至二八开，同时整体难度也要更上一个档次,网上可参考资料也更少，但前端代码可以写的比较简单，是我目前首选。

​	概括: 整个项目只是一个"查看系统"，需要程序读取的信息已经由师兄写好的程序给出(或者说已经由机器产生,我们需要做的**只是读取并显示到网页上**)。**产生数据**的规律为:**每秒**输出信息一条到**txt文件**。简单来说就是要实现读取新增信息并解析，再执行录入MySQL数据库和响应前端请求等等功能。

​	☆是不太懂或者有问题的地方

## 2.0	基本需求

### 2.1	用户模块

​	用户分为管理员、企业用户、普通用户三个角色，可套用之前的登陆注册系统。根据不同的用户权限，使用**RBAC模型**修改**用户类、定义角色类和权限类**。**JWT**可以用来**检验用户的登陆状态**，防止非法强登。

token在localStorage里面存对象

​	

### 2.2	文件模块

#### 2.2.1	项目结构

​                                      	![image-20230415184356434](https://mytyporapicute.oss-cn-guangzhou.aliyuncs.com/typoraPics/image-20230415184356434.png)

​	如果一定要按照图中所示结构来编程的话，程序就是**后端读取和处理**打印机数据，**dao层**方法写入mysql数据库。当有前端请求时，**controller层**的Servlet通过**service层**的方法获取被service层**打包好的**数据库数据，以json格式返回前端，前端接收并显示。此外还有一些信息需要通过ajax和JQuery实现异步通讯，以达到数据在前端实时变化并显示的目的。 *(☆突发奇想: 从打印机txt里读取的**RawData**需不需要存入数据库?)*

​	这里可以使用我用小组作业搞的的**数据库操作工具类，CRUD操作工具类**。**数据库连接池**今晚看看能不能搓一个出来先。√

​	前端的注册登陆需要用**正则表达式校验**，防好sql注入攻击。

​	用户密码的加密脱敏功能先搁置，最后有空再加上去。

#### ☆2.2.2	数据读入(师兄浇浇)

​	txt文件的信息格式为:	t:s (:p…)	，且每秒增加一条。可以使用Java自带的**WatchServiceAPI**设计一个类，监听写入事件,利用Stream等API获取事件发生时**最后一行的**的字符串数据，存入一个**RawData类**中，再用String类split()等方法分割处理。*(☆突发奇想: 从打印机txt里读取的**RawData**需不需要存入数据库?)*

​	第一个参数 t 可以用Java8新增的**若干日期API**进行处理，转化为普通日期。

​	剩下的状态参数 s 和额外参数 p 。第一种处理方法是用一个**PrinterStatus类包装状态信息**，再写一个基于switch的方法，比较复杂和麻烦。第二种处理方法是**定义12个状态类**，也比较复杂和麻烦。



### 2.3	打印机模块

#### ☆2.3.1	前端基础显示数据(师兄浇浇)

​	 前端展示的**打印机数据**利用ajax异步通讯让后台**每秒钟查询一次数据库**即可(感觉查询频率有点高?求师兄指点优化:pray:)。websocket

​	任务进度根据s的不同值，前进或停止。**当且仅当s=41时**进度条前进，前进速度和进度条长度由s=41时的参数决定。进度条的前端显示可能需要**依赖一些我学过的前端**技术。

#### ☆2.3.2	四个时间数据统计(师兄浇浇)

​	数据统计中的**今日累计XX时间**可以用以下方法实现:

​		在后台新建一个自定义的**TimeRecord类**的对象，四个时间都进行如下操作:

​			分别定义一个变量来记录**每次开始计时时间**，当遇到需要**停止计时的**状态码时，就用当前时间减去开始时间，并赋值给另一个**总的计时变量**中。// 不好

​	这四个统计数据需要显示在前端。我认为可以利用ajax异步通讯实时显示，也可以用户**点击按钮时刷新**显示(因为这四个时间数据不需要很强的即时性，甚至单位我觉得**精确到分钟**就好了)。此外，可以**每隔10s和程序关闭**时才将统计的数据**录入**数据库，**减少数据库的访问压力**。

​	**跨天清零**的话, 可以定义一个**变量**来记录当前日期，每次接收到数据时，判断当前日期是否和该变量**相同**，如果不同，说明已经跨天，那么就将所有的**统计变量清零**，并将**当前日期赋值给该变量**。

#### 2.3.3	统计的时间数据，和温度数据，以及操作信息，需要存入数据库

​	这里的数据库表**如何设计**需要好好考虑。

​	☆单对于**操作信息**，我的设想如下:

​	用三个字段存储，第一个字段存s的值，第二个存p1的值(若无存null),第三个存p2的值(若无存null)。

​	实际实现:

​		每个打印机都有一张表存其温度、操作信息和操作信息的时间。有一张独立的存所有打印机ID的表和一张独立的存所有打印机的统计时间数据的表(*计划每个小时、打印完成、程序关闭时才上传数据库*)。

​	独立的存所有打印机的统计时间数据的表:

​	表建好了，现在想怎么统计数据。

​	外层封装PrinterStatistic，内层单个时间封装StatisticTime。发现了梦中情方法LocalTime.ofSecondOfDay(long)。超过一天自动取余也太爽了。

​	

#### 2.3.4	温度统计与温度曲线

​	设想了两种方案:

​		① 某些网站注册时选生日一样点击选择时间，可能需要使用一些我没学过的框架和js库。

​		② 给两个表单，用户**输入开始时间**和要查看的时间**长度**。此方案需要对用户输入进行前端的正则表达式**格式检查**,后台的**时间数据存在性检查**。我会，但是麻烦。

​	此外，**温度曲线该怎么画啊啊...:crying_cat_face::crying_cat_face:**。又要被前端折磨了。



## 3.0	进阶需求

### 3.1	websocket

​	应该是websocket吧，文档好像打错了。虽然我没学，这个知识感觉不折磨，应该也不难，可以研究。

### 3.2	实时预警

​	这个应该也不难，不过当时师兄说要在**网上买资源**才能实现邮箱和短信的实时预警通知，可以研究一下。

### ☆3.3	单体架构的拆分进行(师兄救命)2tomcat/进程间通信

​	这一条也太难懂了:sob:居然还是必做。驻留端到底是个什么?一个存着txt更新数据的队列?(师兄救命)

​	我原先的计划是定义一个监听的Servlet类，设计若干方法一直监听txt文件的更新，将更新的内容以字符串的形式录入一个数据库表中*(突发奇想: 可不可以将读取到的字符串直接发送给负责**处理数据的Servlet**? 这样就不需要将txt里的东西录入数据库了)*。之后再由负责**处理数据的Servlet**从数据库中读取最底下一行数据进行处理。

#### ☆3.3.1	**多台打印机的情况**(师兄救命)

​	我可以为每台打印机创建一个表，表名可以是打印机的编号，表中的字段可以包括日期、时间、状态编码、参数1、参数2、开机时间、打印时间、闲置时间、异常时间、温度等。

​	☆多台打印机同时请求的话，我是不是得使用多线程技术**并发编程**?



## 4.0	高级需求